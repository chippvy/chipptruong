<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chipp Trương (Vy)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000000 !important;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
        }
        #fireworks-trails { z-index: 1; }
        #fireworks-main   { z-index: 2; }
        #text-canvas      { z-index: 3; pointer-events: none; } /* Không chặn click */
    </style>
</head>
<body>

<canvas id="fireworks-trails"></canvas>
<canvas id="fireworks-main"></canvas>
<canvas id="text-canvas"></canvas>

<script>
// ================== PHẦN CHỮ ================== 
const textCanvas = document.getElementById('text-canvas');
const textCtx = textCanvas.getContext('2d');

let width, height;
let currentIndex = 0;
let textParticles = [];

const texts = ['HAPPY', 'NEW', 'YEAR', '2026'];

const colors = [
    '#ff00cc', '#00ffff', '#ffff00', '#33ff33', '#ff3366',
    '#9933ff', '#ff6600', '#00ff99', '#ff99cc', '#66ffff', '#ffd700', '#ff4500'
];

function resize() {
    width = textCanvas.width = 
           document.getElementById('fireworks-trails').width = 
           document.getElementById('fireworks-main').width = window.innerWidth;
    
    height = textCanvas.height = 
             document.getElementById('fireworks-trails').height = 
             document.getElementById('fireworks-main').height = window.innerHeight;

    if (texts[currentIndex]) {
        createTextParticles(texts[currentIndex]);
    }
}

window.addEventListener('resize', resize);

function calculateFontSize(text) {
    const baseSize = Math.min(width, height) * 0.25;
    if (text === 'HAPPY' || text === 'NEW') return `bold ${Math.floor(baseSize * 0.8)}px Arial`;
    if (text === 'YEAR') return `bold ${Math.floor(baseSize * 0.7)}px Arial`;
    if (text === '2026') return `bold ${Math.floor(baseSize * 0.9)}px Arial`;
    return `bold ${Math.floor(baseSize * 0.8)}px Arial`;
}

function createTextParticles(text) {
    textParticles = [];
    const fontSize = calculateFontSize(text);
    
    textCtx.font = fontSize;
    textCtx.textAlign = 'center';
    textCtx.textBaseline = 'middle';

    const offscreen = document.createElement('canvas');
    offscreen.width = width;
    offscreen.height = height;
    const offCtx = offscreen.getContext('2d');
    offCtx.font = fontSize;
    offCtx.textAlign = 'center';
    offCtx.textBaseline = 'middle';
    offCtx.fillStyle = '#fff';
    offCtx.fillText(text, width/2, height/2);

    const imageData = offCtx.getImageData(0, 0, width, height).data;
    const density = width < 768 ? 3 : 2;

    for (let y = 0; y < height; y += density) {
        for (let x = 0; x < width; x += density) {
            const i = (y * width + x) * 4;
            if (imageData[i + 3] > 100) {
                const color = colors[Math.floor(Math.random() * colors.length)];
                const particleSize = Math.max(1, Math.min(width, height) * 0.002);
                
                textParticles.push({
                    baseX: x,
                    baseY: y,
                    x: x,
                    y: y,
                    color,
                    size: Math.random() * particleSize * 2 + particleSize,
                    phase: Math.random() * Math.PI * 2
                });
            }
        }
    }
}

function animateText() {
    // QUAN TRỌNG: Xóa canvas chữ bằng clearRect thay vì fillRect đen mờ
    textCtx.clearRect(0, 0, width, height);

    textParticles.forEach(p => {
        const t = Date.now() * 0.003 + p.phase;
        const brightness = 0.7 + Math.sin(t) * 0.3;
        const offset = Math.sin(t * 1.8) * 0.8;
        textCtx.globalAlpha = brightness;
        textCtx.fillStyle = p.color;
        textCtx.beginPath();
        textCtx.arc(p.baseX + offset, p.baseY + offset * 0.5, p.size, 0, Math.PI * 2);
        textCtx.fill();
    });

    requestAnimationFrame(animateText);
}

// ================== PHẦN PHÁO HOA ==================
const trailsCanvas = document.getElementById('fireworks-trails');
const mainCanvas = document.getElementById('fireworks-main');
const trailsCtx = trailsCanvas.getContext('2d');
const mainCtx = mainCanvas.getContext('2d');

const FIREWORK_COLORS = ['#ff0043', '#14fc56', '#1e7fff', '#e60aff', '#ffbf36', '#ffffff'];

const particles = { stars: [], sparks: [], flashes: [] };

class FireworkStar {
    constructor(x, y, color, angle, speed, life) {
        this.x = x; this.y = y; this.prevX = x; this.prevY = y;
        this.color = color;
        this.speedX = Math.sin(angle) * speed;
        this.speedY = Math.cos(angle) * speed;
        this.life = life; this.maxLife = life;
        this.onDeath = null;
    }
    update(dt) {
        this.prevX = this.x; this.prevY = this.y;
        this.x += this.speedX; this.y += this.speedY;
        this.speedY += 0.001 * dt;
        this.speedX *= 0.99; this.speedY *= 0.99;
        this.life -= dt;
        return this.life > 0;
    }
}

class Spark {
    constructor(x, y, color) {
        this.x = x; this.y = y; this.prevX = x; this.prevY = y;
        this.color = color;
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 0.3 + 0.2;
        this.speedX = Math.sin(angle) * speed;
        this.speedY = Math.cos(angle) * speed;
        this.life = Math.random() * 300 + 300;
        this.maxLife = this.life;
    }
    update(dt) {
        this.prevX = this.x; this.prevY = this.y;
        this.x += this.speedX; this.y += this.speedY;
        this.speedY += 0.0005 * dt;
        this.speedX *= 0.95; this.speedY *= 0.95;
        this.life -= dt;
        return this.life > 0;
    }
}

class Flash {
    constructor(x, y, radius) {
        this.x = x; this.y = y; this.radius = radius;
        this.life = 200; this.maxLife = 200;
    }
    update(dt) { this.life -= dt; return this.life > 0; }
}

function createBurst(x, y, color) {
    const count = 80 + Math.random() * 60;
    const size = 200 + Math.random() * 200;
    const life = 800 + Math.random() * 400;
    
    for (let i = 0; i < count; i++) {
        const angle = Math.random() * Math.PI * 2;
        const speed = size / 100 * Math.random();
        particles.stars.push(new FireworkStar(x, y, color, angle, speed, life));
    }
    particles.flashes.push(new Flash(x, y, size / 8));
    for (let i = 0; i < 20; i++) {
        particles.sparks.push(new Spark(x, y, color));
    }
}

function launchFirework(xRatio, yRatio) {
    const color = FIREWORK_COLORS[Math.floor(Math.random() * FIREWORK_COLORS.length)];
    const targetX = xRatio * width;
    const targetY = yRatio * height;
    const launchY = height;
    
    const distance = launchY - targetY;
    const velocity = Math.sqrt(distance * 0.003);
    
    const star = new FireworkStar(
        targetX, launchY, color,
        -Math.PI / 2, velocity * 1.2,
        distance / velocity * 7
    );
    star.onDeath = () => createBurst(targetX, targetY, color);
    particles.stars.push(star);
}

function startAutoFire() {
    setInterval(() => {
        const x = Math.random() * 0.8 + 0.1;
        const y = Math.random() * 0.6 + 0.2;
        launchFirework(x, y);
    }, 600);
}

function renderFireworks() {
    // Fade hiệu ứng vệt đuôi
    trailsCtx.globalCompositeOperation = 'source-over';
    trailsCtx.fillStyle = 'rgba(0,0,0,0.04)';
    trailsCtx.fillRect(0, 0, width, height);

    // Clear canvas chính
    mainCtx.clearRect(0, 0, width, height);

    // Vẽ flash (ánh sáng chớp)
    trailsCtx.globalCompositeOperation = 'lighter';
    particles.flashes.forEach(f => {
        const a = f.life / f.maxLife;
        trailsCtx.beginPath();
        trailsCtx.arc(f.x, f.y, f.radius * a * 1.2, 0, Math.PI*2);
        trailsCtx.fillStyle = `rgba(255,220,120,${a*0.8})`;
        trailsCtx.fill();
    });

    // Vẽ các ngôi sao (tia pháo hoa chính)
    trailsCtx.lineWidth = 3;
    trailsCtx.lineCap = 'round';
    particles.stars.forEach(s => {
        const a = s.life / s.maxLife;
        trailsCtx.globalAlpha = a * 1.2;
        trailsCtx.strokeStyle = s.color;
        trailsCtx.beginPath();
        trailsCtx.moveTo(s.x, s.y);
        trailsCtx.lineTo(s.prevX, s.prevY);
        trailsCtx.stroke();
    });

    // Vẽ các tia lửa nhỏ
    trailsCtx.lineWidth = 1.5;
    particles.sparks.forEach(s => {
        const a = s.life / s.maxLife;
        trailsCtx.globalAlpha = a * 1.5;
        trailsCtx.strokeStyle = s.color;
        trailsCtx.beginPath();
        trailsCtx.moveTo(s.x, s.y);
        trailsCtx.lineTo(s.prevX, s.prevY);
        trailsCtx.stroke();
    });

    // Reset alpha
    trailsCtx.globalAlpha = 1.0;
    trailsCtx.globalCompositeOperation = 'source-over';
}

function updateParticles(dt) {
    for (let i = particles.stars.length - 1; i >= 0; i--) {
        if (!particles.stars[i].update(dt)) {
            if (particles.stars[i].onDeath) particles.stars[i].onDeath();
            particles.stars.splice(i, 1);
        }
    }
    for (let i = particles.sparks.length - 1; i >= 0; i--) {
        if (!particles.sparks[i].update(dt)) particles.sparks.splice(i, 1);
    }
    for (let i = particles.flashes.length - 1; i >= 0; i--) {
        if (!particles.flashes[i].update(dt)) particles.flashes.splice(i, 1);
    }
}

let lastTime = 0;
function animateAll(currentTime = 0) {
    const dt = Math.min(currentTime - lastTime, 32);
    lastTime = currentTime;

    updateParticles(dt);
    renderFireworks();
    requestAnimationFrame(animateAll);
}

// ================== KHỞI ĐỘNG ==================
resize();
createTextParticles('HAPPY');
animateText();
animateAll();

// Chuyển đổi chữ
setTimeout(() => { currentIndex++; createTextParticles('NEW'); }, 5000);
setTimeout(() => { currentIndex++; createTextParticles('YEAR'); }, 10000);
setTimeout(() => { currentIndex++; createTextParticles('2026'); }, 15000);

// Bắt đầu pháo hoa
startAutoFire();
launchFirework(0.3, 0.3);
launchFirework(0.7, 0.3);
launchFirework(0.5, 0.2);
launchFirework(0.2, 0.4);
launchFirework(0.8, 0.4);

// Tự động chuyển sang file 2.html sau 7 giây khi chữ "2026" xuất hiện
setTimeout(() => {
    window.location.href = "2.html";
}, 15000 + 7000); // 7200ms là thời gian chờ "2026" xuất hiện + 7000ms delay thêm

</script>
</body>
</html>